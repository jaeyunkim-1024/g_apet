<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="coupon">

	<resultMap id="CouponBaseMap" type="biz.app.promotion.model.CouponBaseVO">
		<id 	property="cpNo"				column="CP_NO"/>
		<result property="cpNm"				column="CP_NM"/>
		<result property="cpDscrt"			column="CP_DSCRT"/>
		<result property="cpKindCd"			column="CP_KIND_CD"/>
		<result property="cpStatCd"			column="CP_STAT_CD"/>
		<result property="cpAplCd"			column="CP_APL_CD"/>
		<result property="cpTgCd"			column="CP_TG_CD"/>
		<result property="vldPrdCd"			column="VLD_PRD_CD"/>
		<result property="vldPrdStrtDtm"	column="VLD_PRD_STRT_DTM"/>
		<result property="vldPrdEndDtm"		column="VLD_PRD_END_DTM"/>
		<result property="vldPrdDay"		column="VLD_PRD_DAY"/>
		<result property="cpPvdMthCd"		column="CP_PVD_MTH_CD"/>
		<result property="dupleUseYn"		column="DUPLE_USE_YN"/>
		<result property="cpRstrYn"         column="CP_RSTR_YN"/>
		<result property="splCompDvdRate"	column="SPL_COMP_DVD_RATE"/>
		<result property="isuHostCd"		column="ISU_HOST_CD"/>
		<result property="cpIsuCd"			column="CP_ISU_CD"/>
		<result property="cpIsuQty"			column="CP_ISU_QTY"/>
		<result property="webMobileGbCd"	column="WEB_MOBILE_GB_CD"/>
		<result property="aplVal"			column="APL_VAL"/>
		<result property="minBuyAmt"		column="MIN_BUY_AMT"/>
		<result property="maxDcAmt"			column="MAX_DC_AMT"/>
		<result property="rvsMrgPmtYn"		column="RVS_MRG_PMT_YN"/>
		<result property="aplStrtDtm"		column="APL_STRT_DTM"/>
		<result property="aplEndDtm"		column="APL_END_DTM"/>
		<result property="cpImgFlnm"		column="CP_IMG_FLNM"/>
		<result property="cpImgPathnm"		column="CP_IMG_PATHNM"/>
		<result property="sysRegrNo"		column="SYS_REGR_NO"/>
		<result property="sysRegDtm"		column="SYS_REG_DTM"/>
		<result property="sysUpdrNo"		column="SYS_UPDR_NO"/>
		<result property="sysUpdDtm"		column="SYS_UPD_DTM"/>
		<result property="sysRegrNm"		column="SYS_REGR_NM"/>
		<result property="sysUpdrNm"		column="SYS_UPDR_NM"/>
		<result property="prmtAplGbCd"		column="PRMT_APL_GB_CD"/>
		<result property="cpShowYn"		    column="CP_SHOW_YN"/>
		<result property="isuTgCd"		    column="ISU_TG_CD"/>
		<result property="msgSndYn"			column="MSG_SND_YN"/>
		<result property="exprItdcYn"		column="EXPR_ITDC_YN"/>
		<result property="outsideCpYn"		column="OUTSIDE_CP_YN"/>
		<result property="outsideCpCd"		column="OUTSIDE_CP_CD"/>
		<result property="notice"			column="NOTICE"/>
		<result property="multiAplYn"		column="MULTI_APL_YN"/>
		<result property="mbrGrdCd"			column="MBR_GRD_CD"/>
		<result property="cpCd"				column="CP_CD"/>
		<collection property="stStdList" column="{aplNo=CP_NO, prmtAplGbCd=PRMT_APL_GB_CD, stUseYn=ST_USE_YN}" javaType="java.util.ArrayList" ofType="biz.app.st.model.StStdInfoVO" select="inline.getStStdInfoPrmtById"/>
	</resultMap>

	<select id="getStStdInfoPrmtById" resultType="biz.app.st.model.StStdInfoVO">
		SELECT /* coupon.getStStdInfoPrmtById */
			M.ST_ID, S.ST_NM
		FROM
			ST_STD_INFO S INNER JOIN ST_PRMT_MAP M ON S.ST_ID = M.ST_ID
		WHERE
			M.APL_NO = #{cpNo} AND
			M.PRMT_APL_GB_CD = #{prmtAplGbCd}
	</select>

	<select id="pageCouponBase" resultMap="CouponBaseMap">
		<!--
			Query Name : coupon.pageCouponBase
			Description : 쿠폰 페이지 리스트
		-->
		SELECT	/* QUERYID(coupon.pageCouponBase) */
				C.CP_NO					/* 쿠폰 번호 */
				, CP_NM					/* 쿠폰 명 */
				, CP_DSCRT				/* 쿠폰 설명 */
				, CP_KIND_CD			/* 쿠폰 종류 코드 */
				, CP_STAT_CD			/* 쿠폰 상태 코드 */
				, CP_APL_CD				/* 쿠폰 적용 코드 */
				, CP_TG_CD				/* 쿠폰 대상 코드 */
				, VLD_PRD_CD    		/* 유효 기간 코드 */
				, VLD_PRD_STRT_DTM		/* 유효 기간 시작 일시 */
				, VLD_PRD_END_DTM		/* 유효 기간 종료 일시 */
				, VLD_PRD_DAY			/* 유효 기간 일 */
				, CP_PVD_MTH_CD			/* 쿠폰 지급 방식 코드 */
				, DUPLE_USE_YN			/* 중복 사용 여부 */
				, CP_RSTR_YN            /* 복원 가능 여부 */
				, SPL_COMP_DVD_RATE		/* 공급 업체 분담 율 */
				, ISU_HOST_CD			/* 발급 주체 코드 */
				, CP_ISU_CD				/* 쿠폰 발급 코드 */
				, CP_ISU_QTY			/* 쿠폰 발급 수량 */
				, WEB_MOBILE_GB_CD		/* 웹 모바일 구분 코드 */
				, APL_VAL				/* 적용 값 */
				, MIN_BUY_AMT			/* 최소 구매 금액 */
				, MAX_DC_AMT			/* 최대 할인 금액 */
				, RVS_MRG_PMT_YN		/* 역 마진 허용 여부 */
				, APL_STRT_DTM			/* 적용 시작 일시 */
				, APL_END_DTM			/* 적용 종료 일시 */
				, CP_IMG_FLNM			/* 쿠폰 이미지 파일명 */
				, CP_IMG_PATHNM			/* 쿠폰 이미지 경로명 */
				, ISU_TG_CD				/* 발급 대상 코드 */
				, MSG_SND_YN			/* 메세지 발송 여부 */
				, EXPR_ITDC_YN			/* 만료 안내 여부 */
				, OUTSIDE_CP_YN			/* 외부 쿠폰 여부 */
				, OUTSIDE_CP_CD			/* 외부 쿠폰 코드 */
				, NOTICE				/* 유의사항 */
				, MULTI_APL_YN			/* 복수 적용 여부 */
				, SYS_REGR_NO			/* 시스템 등록자 번호 */
				, SYS_REG_DTM			/* 시스템 등록 일시 */
				, SYS_UPDR_NO			/* 시스템 수정자 번호 */
				, SYS_UPD_DTM			/* 시스템 수정 일시 */
				, FN_GET_USER_NAME(SYS_REGR_NO) AS SYS_REGR_NM	/* 시스템 등록자 */
				, FN_GET_USER_NAME(SYS_UPDR_NO) AS SYS_UPDR_NM	/* 시스템 수정자 */
				, '${@framework.common.constants.CommonConstants@PRMT_APL_GB_20}' AS PRMT_APL_GB_CD
				, '${@framework.common.constants.CommonConstants@COMM_YN_Y}' ST_USE_YN
		FROM	COUPON_BASE C
		WHERE	1 = 1
		<if test="stId != null and stId != ''">
			AND EXISTS (SELECT 1
						FROM
							(SELECT M.APL_NO AS CP_NO
							FROM ST_STD_INFO S JOIN ST_PRMT_MAP M ON S.ST_ID = M.ST_ID
							WHERE S.ST_ID = #{stId} AND M.PRMT_APL_GB_CD = '${@framework.common.constants.CommonConstants@PRMT_APL_GB_20}') SM
						WHERE C.CP_NO = SM.CP_NO)
		</if>
		<include refid="coupon.pageCouponBaseWhere" />
		<include refid="bizCommon.sortSql" />
		<include refid="bizCommon.pageSql" />
	</select>

	<select id="pageCouponBaseCount" resultType="java.lang.Integer">
		<!--
			Query Name : common.test
			Description : test
		-->
		SELECT	/* QUERYID(coupon.pageCouponCount) */
				COUNT(*)
		FROM	COUPON_BASE C
		WHERE	1 = 1
		<if test="stId != null and stId != ''">
			AND EXISTS (SELECT 1
						FROM
							(SELECT M.APL_NO AS CP_NO
							FROM ST_STD_INFO S JOIN ST_PRMT_MAP M ON S.ST_ID = M.ST_ID
							WHERE S.ST_ID = #{stId} AND M.PRMT_APL_GB_CD = '${@framework.common.constants.CommonConstants@PRMT_APL_GB_20}') SM
						WHERE C.CP_NO = SM.CP_NO)
		</if>
		<include refid="coupon.pageCouponBaseWhere" />
	</select>

	<sql id="pageCouponBaseWhere">
		<if test='aplStrtDtm != null and aplEndDtm != null'>
		<!--
			1. 검색기간 끝보다 적용기간 끝이 과거인 경우 적용기간 끝이 검색기간 사이에 있어야 한다.
			2. 검색기간 끝보다 적용기간 끝이 미래인 경우 적용기간 시작이 검색기간 끝보다 과거여야 한다.
		 -->
		AND ( (#{aplEndDtm} &gt;= APL_END_DTM AND APL_END_DTM BETWEEN #{aplStrtDtm} AND #{aplEndDtm}) OR
		(#{aplEndDtm} &lt;= APL_END_DTM AND APL_STRT_DTM &lt;= #{aplEndDtm}) )
		</if>
		<if test='cpNm != null and cpNm != ""'>
		AND		CP_NM LIKE CONCAT('%', #{cpNm}, '%')
		</if>
		<if test='cpAplCd != null and cpAplCd != ""'>
		AND		CP_APL_CD = #{cpAplCd}
		</if>
		<if test='cpStatCd != null and cpStatCd != ""'>
		AND		CP_STAT_CD = #{cpStatCd}
		</if>
		<if test='cpKindCd != null and cpKindCd != ""'>
		AND		CP_KIND_CD = #{cpKindCd}
		</if>
		<if test='cpPvdMthCd != null and cpPvdMthCd != ""'>
		AND		CP_PVD_MTH_CD = #{cpPvdMthCd}
		</if>
        <if test='cpTgCd != null and cpTgCd != ""'>
        AND     CP_TG_CD = #{cpTgCd}
        </if>		
	</sql>

	<select id="getCouponBase" resultMap="CouponBaseMap">
		<!--
			Query Name : coupon.getCouponBase
			Description : 쿠폰 페이지 리스트
		-->
		SELECT	/* QUERYID(coupon.getCouponBase) */
				C.CP_NO					/* 쿠폰 번호 */
				, CP_NM					/* 쿠폰 명 */
				, CP_DSCRT				/* 쿠폰 설명 */
				, CP_KIND_CD			/* 쿠폰 종류 코드 */
				, CP_STAT_CD			/* 쿠폰 상태 코드 */
				, CP_APL_CD				/* 쿠폰 적용 코드 */
				, CP_TG_CD				/* 쿠폰 대상 코드 */
				, VLD_PRD_CD			/* 유효 기간 코드 */
				, VLD_PRD_STRT_DTM		/* 유효 기간 시작 일시 */
				, VLD_PRD_END_DTM		/* 유효 기간 종료 일시 */
				, VLD_PRD_DAY			/* 유효 기간 일 */
				, CP_PVD_MTH_CD			/* 쿠폰 지급 방식 코드 */
				, DUPLE_USE_YN			/* 중복 사용 여부 */
				, CP_RSTR_YN            /* 복원 가능 여부 */
				, SPL_COMP_DVD_RATE		/* 공급 업체 분담 율 */
				, ISU_HOST_CD			/* 발급 주체 코드 */
				, CP_ISU_CD				/* 쿠폰 발급 코드 */
				, CP_ISU_QTY			/* 쿠폰 발급 수량 */
				, WEB_MOBILE_GB_CD		/* 웹 모바일 구분 코드 */
				, APL_VAL				/* 적용 값 */
				, MIN_BUY_AMT			/* 최소 구매 금액 */
				, MAX_DC_AMT			/* 최대 할인 금액 */
				, RVS_MRG_PMT_YN		/* 역 마진 허용 여부 */
				, APL_STRT_DTM			/* 적용 시작 일시 */
				, APL_END_DTM			/* 적용 종료 일시 */
				, CP_IMG_FLNM			/* 쿠폰 이미지 파일명 */
				, CP_IMG_PATHNM			/* 쿠폰 이미지 경로명 */
				, CP_SHOW_YN            /* 쿠폰존 노출 여부 */
				, ISU_TG_CD				/* 발급 대상 코드 */
				, MSG_SND_YN			/* 메세지 발송 여부 */
				, EXPR_ITDC_YN			/* 만료 안내 여부 */
				, OUTSIDE_CP_YN			/* 외부 쿠폰 여부 */
				, OUTSIDE_CP_CD			/* 외부 쿠폰 코드 */
				, NOTICE				/* 유의사항 */
				, MULTI_APL_YN			/* 복수 적용 여부 */
				, CASE WHEN C.CP_PVD_MTH_CD = '50' 
				       THEN (SELECT ISU_SRL_NO FROM COUPON_ISSUE WHERE CP_NO = C.CP_NO) 
				       ELSE NULL
				  END AS CP_CD			/* 쿠폰 코드 */
			    , GROUP_CONCAT(CMG.MBR_GRD_CD) AS MBR_GRD_CD /* 회원 등급 코드 */
				, C.SYS_REGR_NO			/* 시스템 등록자 번호 */
				, C.SYS_REG_DTM			/* 시스템 등록 일시 */
				, SYS_UPDR_NO			/* 시스템 수정자 번호 */
				, SYS_UPD_DTM			/* 시스템 수정 일시 */
				, FN_GET_USER_NAME(C.SYS_REGR_NO) AS SYS_REGR_NM	/* 시스템 등록자 */
				, FN_GET_USER_NAME(SYS_UPDR_NO) AS SYS_UPDR_NM	/* 시스템 수정자 */
				, '${@framework.common.constants.CommonConstants@PRMT_APL_GB_20}' AS PRMT_APL_GB_CD
				, '${@framework.common.constants.CommonConstants@COMM_YN_Y}' ST_USE_YN
		FROM	COUPON_BASE C
		    LEFT OUTER JOIN COUPON_MBR_GRD CMG
		  	    ON C.CP_NO = CMG.CP_NO
		WHERE	1=1
		<if test="cpNo != null">
		AND	C.CP_NO = #{cpNo}
		</if>
		<if test="mbrCpNo != null">
		AND	C.CP_NO = (SELECT CP_NO FROM MEMBER_COUPON WHERE MBR_CP_NO = #{mbrCpNo})
		</if>
	</select>

	<insert id="insertCouponBase" parameterType="biz.app.promotion.model.CouponBasePO">
		<!--
			Query Name : coupon.insertCouponBase
			Description : 쿠폰 베이스 등록
		-->
		INSERT INTO COUPON_BASE (
			  CP_NO					/* 쿠폰 번호 */
			, CP_NM					/* 쿠폰 명 */
			, CP_DSCRT				/* 쿠폰 설명 */
			, CP_KIND_CD			/* 쿠폰 종류 코드 */
			, CP_STAT_CD			/* 쿠폰 상태 코드 */
			, CP_APL_CD				/* 쿠폰 적용 코드 */
			, CP_TG_CD				/* 쿠폰 대상 코드 */
			, VLD_PRD_CD			/* 유효 기간 코드 */
			, VLD_PRD_STRT_DTM		/* 유효 기간 시작 일시 */
			, VLD_PRD_END_DTM		/* 유효 기간 종료 일시 */
			, VLD_PRD_DAY			/* 유효 기간 일 */
			, CP_PVD_MTH_CD			/* 쿠폰 지급 방식 코드 */
			, DUPLE_USE_YN 			/* 중복 사용 여부 */
			, CP_RSTR_YN            /* 쿠폰 복원 여부 */
			, SPL_COMP_DVD_RATE		/* 공급 업체 분담 율 */
			, ISU_HOST_CD			/* 발급 주체 코드 */
			, CP_ISU_CD				/* 쿠폰 발급 코드 */
			, CP_ISU_QTY			/* 쿠폰 발급 수량 */
			, APL_VAL				/* 적용 값 */
			, MIN_BUY_AMT			/* 최소 구매 금액 */
			, MAX_DC_AMT			/* 최대 할인 금액 */
			, RVS_MRG_PMT_YN        /* 역마진 허용여부 */
			, APL_STRT_DTM			/* 적용 시작 일시 */
			, APL_END_DTM			/* 적용 종료 일시 */
			, CP_IMG_FLNM			/* 쿠폰 이미지 파일명 */
			, CP_IMG_PATHNM			/* 쿠폰 이미지 경로명 */
			, WEB_MOBILE_GB_CD		/* 웹 모바일 구분 코드 */
			, CP_SHOW_YN		    /* 쿠폰존 노출 여부 */
			, ISU_TG_CD				/* 발급 대상 코드 */
			, MSG_SND_YN			/* 메세지 발송 여부 */
			, EXPR_ITDC_YN			/* 만료 안내 여부 */
			, OUTSIDE_CP_YN			/* 외부 쿠폰 여부 */
			, OUTSIDE_CP_CD			/* 외부 쿠폰 코드 */
			, NOTICE				/* 유의사항 */
			, MULTI_APL_YN			/* 복수 적용 여부 */
			, SYS_REGR_NO			/* 시스템 등록자 번호 */
			, SYS_REG_DTM			/* 시스템 등록 일시 */
			, SYS_UPDR_NO			/* 시스템 수정자 번호 */
			, SYS_UPD_DTM			/* 시스템 수정 일시 */
		) VALUES (
			  #{cpNo}				/* 쿠폰 번호 */
			, #{cpNm}				/* 쿠폰 명 */
			, #{cpDscrt}			/* 쿠폰 설명 */
			, #{cpKindCd}			/* 쿠폰 종류 코드 */
			, #{cpStatCd}			/* 쿠폰 상태 코드 */
			, #{cpAplCd}			/* 쿠폰 적용 코드 */
			, #{cpTgCd}				/* 쿠폰 대상 코드 */
			, #{vldPrdCd}			/* 유효 기간 코드 */
			, #{vldPrdStrtDtm}		/* 유효 기간 시작 일시 */
			, DATE_ADD(#{vldPrdEndDtm}, INTERVAL 1 DAY) - INTERVAL 1 SECOND		/* 유효 기간 종료 일시 */
			, #{vldPrdDay}			/* 유효 기간 일 */
			, #{cpPvdMthCd}			/* 쿠폰 지급 방식 코드 */
			, 'N'        			/* 중복 사용 여부 */
			, 'Y'		            /* 쿠폰 복원 여부 */
			, #{splCompDvdRate}		/* 공급 업체 분담 율 */
			, #{isuHostCd}			/* 발급 주체 코드 */
			, #{cpIsuCd}			/* 쿠폰 발급 코드 */
			, #{cpIsuQty}			/* 쿠폰 발급 수량 */
			, #{aplVal}				/* 적용 값 */
			, #{minBuyAmt}			/* 최소 구매 금액 */
			, #{maxDcAmt}			/* 최대 할인 금액 */
			, 'Y'					/* 역 마진 허용 여부 */
			, #{aplStrtDtm}			/* 적용 시작 일시 */
			, DATE_ADD(#{aplEndDtm}, INTERVAL 1 DAY) - INTERVAL 1 SECOND			/* 적용 종료 일시 */
			, #{cpImgFlnm}			/* 쿠폰 이미지 파일명 */
			, #{cpImgPathnm}		/* 쿠폰 이미지 경로명 */
			, #{webMobileGbCd}		/* 웹 모바일 구분 코드 */
			, #{cpShowYn}		    /* 쿠폰존 노출 여부 */
			, #{isuTgCd}			/* 발급 대상 코드 */
			, #{msgSndYn}			/* 메세지 발송 여부 */
			, #{exprItdcYn}			/* 만료 안내 여부 */
			, #{outsideCpYn}		/* 외부 쿠폰 여부 */
			, #{outsideCpCd}		/* 외부 쿠폰 코드 */
			, #{notice}				/* 유의사항 */
			, 'Y'		/* 복수 적용 여부 */
			, #{sysRegrNo}			/* 시스템 등록자 번호 */
			, NOW()					/* 시스템 등록 일시 */
			, #{sysUpdrNo}			/* 시스템 수정자 번호 */
			, NOW()					/* 시스템 수정 일시 */
		)
	</insert>

	<update id="updateCouponBase" parameterType="biz.app.promotion.model.CouponBasePO">
		<!--
			Query Name : coupon.updateCouponBase
			Description : 쿠폰 베이스 수정
		-->
		UPDATE	COUPON_BASE SET
				  CP_NM					= #{cpNm}				/* 쿠폰 명 */
				, CP_DSCRT				= #{cpDscrt}			/* 쿠폰 설명 */
				, CP_KIND_CD			= #{cpKindCd}			/* 쿠폰 종류 코드 */
				, CP_STAT_CD			= #{cpStatCd}			/* 쿠폰 상태 코드 */
				, CP_APL_CD				= #{cpAplCd}			/* 쿠폰 적용 코드 */
				, CP_TG_CD				= #{cpTgCd}				/* 쿠폰 대상 코드 */
				, VLD_PRD_CD			= #{vldPrdCd}			/* 유효 기간 코드 */
				, VLD_PRD_STRT_DTM		= #{vldPrdStrtDtm}		/* 유효 기간 시작 일시 */
				, VLD_PRD_END_DTM		= DATE_ADD(#{vldPrdEndDtm}, INTERVAL 1 DAY) - INTERVAL 1 SECOND 	/* 유효 기간 종료 일시 */
				, VLD_PRD_DAY			= #{vldPrdDay}			/* 유효 기간 일 */
				, SPL_COMP_DVD_RATE		= #{splCompDvdRate}		/* 공급 업체 분담 율 */
				, ISU_HOST_CD			= #{isuHostCd}			/* 발급 주체 코드 */
				, CP_PVD_MTH_CD         = #{cpPvdMthCd}         /* 쿠폰 지급 방식 */
				, CP_ISU_CD             = #{cpIsuCd}            /* 발급 수량 코드 */
				, CP_ISU_QTY            = #{cpIsuQty}           /* 발급 수량 */
				, APL_VAL				= #{aplVal}				/* 적용 값 */
				, MIN_BUY_AMT			= #{minBuyAmt}			/* 최소 구매 금액 */
				, MAX_DC_AMT			= #{maxDcAmt}			/* 최대 할인 금액 */
				, APL_STRT_DTM			= #{aplStrtDtm}			/* 적용 시작 일시 */
				, APL_END_DTM			= DATE_ADD(#{aplEndDtm}, INTERVAL 1 DAY) - INTERVAL 1 SECOND			/* 적용 종료 일시 */
				, CP_IMG_FLNM			= #{cpImgFlnm}			/* 쿠폰 이미지 파일명 */
				, CP_IMG_PATHNM			= #{cpImgPathnm}		/* 쿠폰 이미지 경로명 */
				, WEB_MOBILE_GB_CD		= #{webMobileGbCd}		/* 웹 모바일 구분 코드 */
				, CP_SHOW_YN            = #{cpShowYn}		    /* 쿠폰존 노출 여부 */
				, ISU_TG_CD				= #{isuTgCd}			/* 발급 대상 코드 */
				, MSG_SND_YN 			= #{msgSndYn}			/* 메세지 발송 여부 */
				, EXPR_ITDC_YN			= #{exprItdcYn}			/* 만료 안내 여부 */
				, OUTSIDE_CP_YN 		= #{outsideCpYn}		/* 외부 쿠폰 여부 */
				, OUTSIDE_CP_CD 		= #{outsideCpCd}		/* 외부 쿠폰 코드 */
				, NOTICE				= #{notice}				/* 유의사항 */
				, SYS_UPDR_NO			= #{sysUpdrNo}			/* 시스템 수정자 번호 */
				, SYS_UPD_DTM			= NOW()					/* 시스템 수정 일시 */
		WHERE	CP_NO					= #{cpNo}
	</update>

	<delete id="deleteCouponBase" parameterType="biz.app.promotion.model.CouponBasePO">
		<!--
			Query Name : coupon.updateCouponBase
			Description : 쿠폰 베이스 수정
		-->
		DELETE
		FROM	COUPON_BASE
		WHERE	CP_NO = #{cpNo}
	</delete>

	<insert id="insertStStdCouponMap" parameterType="biz.app.st.model.StStdInfoPO">
		<!--
			Query Name : company.insertStStdCouponMap
			Description : 사이트와 쿠폰 매핑 등록
		-->
		INSERT INTO ST_PRMT_MAP (
			  ST_ID				/* 사이트 아이디 */
			, APL_NO			/* 쿠폰 번호 */
			, PRMT_APL_GB_CD	/* 프로모션/쿠폰/이벤트 구본 코드 */
			, SYS_REGR_NO		/* 시스템 등록자 번호 */
			, SYS_REG_DTM		/* 시스템 등록 일시 */
			, SYS_UPDR_NO		/* 시스템 수정자 번호 */
			, SYS_UPD_DTM		/* 시스템 수정 일시 */
		) VALUES (
			  #{stId}			/* 사이트 아이디 */
			, #{cpNo}			/* 쿠폰 번호 */
			, '${@framework.common.constants.CommonConstants@PRMT_APL_GB_20}' /* 프로모션/쿠폰/이벤트 구본 코드 */
			, #{sysRegrNo}		/* 시스템 등록자 번호 */
			, NOW()				/* 시스템 등록 일시 */
			, #{sysUpdrNo}		/* 시스템 수정자 번호 */
			, NOW()				/* 시스템 수정 일시 */
		)
	</insert>

	<delete id="deleteStStdCouponMap" parameterType="biz.app.promotion.model.CouponBasePO">
		<!--
			Query Name : delete.deleteStStdCouponMap
			Description : 쿠폰에 매핑된 사이트 정보를 모두 삭제
		-->
		DELETE FROM ST_PRMT_MAP
		<choose>
			<when test="cpNo != null and cpNo != ''">
				WHERE APL_NO = #{cpNo}
					AND PRMT_APL_GB_CD = '${@framework.common.constants.CommonConstants@PRMT_APL_GB_20}'
			</when>
			<otherwise>
				WHERE 1 = 2
			</otherwise>
		</choose>
	</delete>

	<select id="getCouponBaseDeleteCheck" resultType="java.lang.Integer">
		<!--
			Query Name : common.test
			Description : test
		-->
		SELECT	/* QUERYID(coupon.getCouponBaseDeleteCheck) */
				COUNT(*)
		FROM	MEMBER_COUPON
		WHERE	CP_NO = #{cpNo}
	</select>

	<select id="getCouponIsDownYn" resultType="biz.app.member.model.MemberCouponVO">
		SELECT
		       (
					SELECT COUNT(*)
		            FROM COUPON_BASE CB
		            WHERE 1 = 1
		            AND IFNULL(CB.CP_ISU_QTY,999999999) &gt; (
		            	SELECT COUNT(*)
		                FROM MEMBER_COUPON MB
		                WHERE MB.CP_NO = CB.CP_NO
					)
					<include refid="pageCouponCondition" />
				 ) AS CP_DOWN_CNT
			,	(
					SELECT COUNT(*)
			    	FROM MEMBER_COUPON MC
			    	WHERE MC.CP_NO IN (
						SELECT CB.CP_NO
						FROM COUPON_BASE CB
						WHERE 1 = 1
						AND IFNULL(CB.CP_ISU_QTY,999999999) &gt; (
							SELECT COUNT(*)
							FROM MEMBER_COUPON SUB
							WHERE SUB.CP_NO = CB.CP_NO
						)
						<include refid="pageCouponCondition" />
					) AND MC.MBR_NO = #{mbrNo}
				) AS MBR_CP_DOWN_CNT
		FROM DUAL
	</select>

	<!-- 쿠폰 목록 -->
	<select id="pageCoupon" resultType="biz.app.promotion.model.CouponBaseVO">
		<!--
			Query Name : coupon.pageCoupon
			Description : FO 쿠폰존 페이지 리스트
			Writter : 김재윤
		-->
		SELECT	/* QUERYID(coupon.pageCoupon) */
				  CB.*				/* 쿠폰 번호 */
				, IF(LENGTH(CB.CP_NM) > 48,CONCAT(SUBSTR(CB.CP_NM,1,16),'...'),CB.CP_NM) AS CP_SHT_NM	/* 쿠폰 약어 */
				, IF(CP_ISU_CD='${@framework.common.constants.CommonConstants@CP_ISU_10}','${@framework.common.constants.CommonConstants@COMM_YN_N}',
						(
							IF(((SELECT COUNT(*) FROM MEMBER_COUPON WHERE CP_NO = CB.CP_NO) <![CDATA[<]]> CP_ISU_QTY),'${@framework.common.constants.CommonConstants@COMM_YN_N}','${@framework.common.constants.CommonConstants@COMM_YN_Y}')
						)
					) CP_END_YN
				<choose>
					<when test='mbrNo != null and mbrNo != ""'>
						,IF(
							(
								IFNULL(CB.CP_ISU_QTY,999999999) &gt; (SELECT COUNT(*) FROM MEMBER_COUPON WHERE CP_NO = CB.CP_NO) /** 쿠폰 발급 제한 수 체크 */
							), IF(
										(														/** 쿠폰 발급 제한 수에 도달하지 않았을 때*/
											SELECT IFNULL(COUNT(CP_NO), 0) AS MEMBER_CNT
											FROM	MEMBER_COUPON
											WHERE CP_NO = CB.CP_NO AND MBR_NO = #{mbrNo}
										) > 0
									,'${@framework.common.constants.CommonConstants@COMM_YN_Y}','${@framework.common.constants.CommonConstants@COMM_YN_N}'
								),'${@framework.common.constants.CommonConstants@COMM_YN_Y}'
						) AS CP_DW_YN
				, IF((SELECT IFNULL(COUNT(CP_NO), 0) AS MEMBER_CNT FROM	MEMBER_COUPON WHERE CP_NO = CB.CP_NO AND USE_YN = 'N' AND NOW() BETWEEN USE_STRT_DTM AND USE_END_DTM AND MBR_NO = #{mbrNo} ) > 0, '${@framework.common.constants.CommonConstants@COMM_YN_N}','${@framework.common.constants.CommonConstants@COMM_YN_Y}') AS CP_USE_YN
					</when>
					<otherwise>
				, 	IF(
						IFNULL(CB.CP_ISU_QTY,999999999) &gt; (SELECT COUNT(*) FROM MEMBER_COUPON WHERE CP_NO = CB.CP_NO) /** 쿠폰 발급 제한 수 체크 */
						, '${@framework.common.constants.CommonConstants@COMM_YN_N}' , '${@framework.common.constants.CommonConstants@COMM_YN_Y}'
					) AS CP_DW_YN
					</otherwise>
				</choose>
				, FN_GET_USER_NAME(SYS_REGR_NO) AS SYS_REGR_NM	/* 시스템 등록자 */
				, FN_GET_USER_NAME(SYS_UPDR_NO) AS SYS_UPDR_NM	/* 시스템 수정자 */
		FROM	(
					SELECT            CP_NO				/* 쿠폰 번호 */
					, CP_NM				/* 쿠폰 명 */
					, CP_DSCRT			/* 쿠폰 설명 */
					, CP_KIND_CD			/* 쿠폰 종류 코드 */
					, FN_GET_CODE_NAME('${@framework.common.constants.CommonConstants@CP_KIND}',CP_KIND_CD,'') AS CP_KIND_NM			/* 쿠폰 종류 이름 */
					, CP_TG_CD			/* 쿠폰 대상 코드 */
					, DUPLE_USE_YN		/* 중복 사용 여부 */
					, SPL_COMP_DVD_RATE /* 공급 업체 분담 율 */
					, CP_PVD_MTH_CD
					, ISU_HOST_CD		/* 발급 주체 코드 */
					, CP_ISU_CD			/* 쿠폰 발급 코드 */
					, CP_ISU_QTY			/* 쿠폰 발급 수량 */
					, CP_STAT_CD			/* 쿠폰 상태 코드 */
					, CP_APL_CD			/* 쿠폰 적용 코드 */
					, CEIL(APL_VAL) AS APL_VAL		/* 적용 값 */
					, IFNULL(MIN_BUY_AMT,0) AS MIN_BUY_AMT		/* 최소 구매 금액 */
					, IFNULL(MAX_DC_AMT,0) AS MAX_DC_AMT			/* 최대 할인 금액 */
					, RVS_MRG_PMT_YN		/* 역 마진 허용 여부 */
					, APL_STRT_DTM		/* 적용 시작 일시 */
					, APL_END_DTM		/* 적용 종료 일시 */
					, CP_SHOW_YN		/* 쿠폰존 노출 여부 */
					, VLD_PRD_CD		/* 유효기간 구분 코드 */
					, IFNULL(VLD_PRD_STRT_DTM,NOW()) AS VLD_PRD_STRT_DTM
					, IF(VLD_PRD_CD='20',VLD_PRD_END_DTM,DATE_FORMAT(DATE_ADD(DATE_FORMAT(NOW(),'%Y-%m-%d'),INTERVAL VLD_PRD_DAY DAY),'%Y-%m-%d %H:%i:%s')) AS VLD_PRD_END_DTM
					, VLD_PRD_DAY
					, CP_IMG_FLNM		/* 쿠폰 이미지 파일명 */
					, CP_IMG_PATHNM		/* 쿠폰 이미지 경로명 */
					, WEB_MOBILE_GB_CD	/* 웹 모바일 구분 코드 */
					, ISU_TG_CD			/* 발급 대상 코드 */
					, MSG_SND_YN		/* 메세지 발송 여부 */
					, NOTICE			/* 유의사항 */
					, OUTSIDE_CP_YN		/*  외부 쿠폰 여부  */
					, OUTSIDE_CP_CD		/*  외부 쿠폰 코드  */
					, EXPR_ITDC_YN		/* 만료 안내 여부 */
					, MULTI_APL_YN		/* 복수 적용 여부 */
					, SYS_REGR_NO		/* 시스템 등록자 번호 */
					, SYS_REG_DTM		/* 시스템 등록 일시 */
					, SYS_UPDR_NO		/* 시스템 수정자 번호 */
					, SYS_UPD_DTM		/* 시스템 수정 일시 */
					FROM COUPON_BASE
		) CB
		WHERE	1 = 1
		<include refid="pageCouponCondition" />
		<include refid="bizCommon.sortSql" />
		<include refid="bizCommon.pageSql" />
	</select>

	<!-- 쿠폰 목록 : 데이터 수-->
	<select id="pageCouponCount" resultType="java.lang.Integer">
		SELECT	/* QUERYID(coupon.pageCouponCount) */
				COUNT(*)
		FROM	COUPON_BASE CB
		WHERE	1 = 1
		<include refid="pageCouponCondition" />
	</select>

	<!-- 쿠폰 목록 : 조건절 -->
	<sql id="pageCouponCondition">
		AND	( CURDATE() &lt;= CB.APL_END_DTM AND CURDATE() &gt;= CB.APL_STRT_DTM )
		AND CB.CP_PVD_MTH_CD = '${@framework.common.constants.CommonConstants@CP_PVD_MTH_10}'
		AND CB.CP_NO NOT IN (
				SELECT USR_DFN1_VAL
				FROM code_detail
				WHERE GRP_CD = '${@framework.common.constants.CommonConstants@AUTO_ISU_COUPON}'
		)
		<if test="isuTgCd != null and isuTgCd != '' ">
			<choose>
				<when test="isuTgCd.equals(@framework.common.constants.CommonConstants@ISU_TG_00)">
					AND CB.ISU_TG_CD IN (
					'${@framework.common.constants.CommonConstants@ISU_TG_00}'
					,	'${@framework.common.constants.CommonConstants@ISU_TG_10}'
					,	'${@framework.common.constants.CommonConstants@ISU_TG_20}'
					)
				</when>
				<when test="isuTgCd.equals(@framework.common.constants.CommonConstants@ISU_TG_10)">
					AND CB.ISU_TG_CD IN (
					'${@framework.common.constants.CommonConstants@ISU_TG_00}'
					,	'${@framework.common.constants.CommonConstants@ISU_TG_10}'
					)
				</when>
				<when test="isuTgCd.equals(@framework.common.constants.CommonConstants@ISU_TG_20)">
					AND CB.ISU_TG_CD IN (
					'${@framework.common.constants.CommonConstants@ISU_TG_00}'
					,	'${@framework.common.constants.CommonConstants@ISU_TG_20}'
					)
				</when>
				<otherwise></otherwise>
			</choose>
		</if>
		<if test='cpKindCd != null and cpKindCd != ""'>
			AND	CB.CP_KIND_CD = #{cpKindCd}
		</if>
		<if test='cpStatCd != null and cpStatCd != ""'>
			AND	CB.CP_STAT_CD = #{cpStatCd}
		</if>
		<if test='cpTgCd != null and cpTgCd != ""'>
			AND	CB.CP_TG_CD = #{cpTgCd}
		</if>
		<if test='cpAplCd != null and cpAplCd != ""'>
			AND	CB.CP_APL_CD = #{cpAplCd}
		</if>
		<if test='cpShowYn != null and cpShowYn !=""'>
			AND	CB.CP_SHOW_YN = #{cpShowYn}
		</if>
		<if test='outsideCpYn != null and outsideCpYn !=""'>
			AND	CB.OUTSIDE_CP_YN = #{outsideCpYn}
		</if>
		<if test="webMobileGbCdList != null" >
			<foreach collection="webMobileGbCdList" item="webMobileGbCd" separator="," open="AND WEB_MOBILE_GB_CD IN (" close=")" >
				#{webMobileGbCd}
			</foreach>
		</if>
	</sql>

	<resultMap id="CouponTargetMap" type="biz.app.promotion.model.CouponTargetVO">
		<id property="goodsId"				column="GOODS_ID"/>
		<result property="compGoodsId"      column="COMP_GOODS_ID"/>
		<result property="goodsNm"			column="GOODS_NM"/>
		<result property="goodsStatCd"		column="GOODS_STAT_CD"/>
		<result property="mdlNm"			column="MDL_NM"/>
		<result property="compNo"			column="COMP_NO"/>
		<result property="mmft"				column="MMFT"/>
		<result property="saleStrtDtm"		column="SALE_STRT_DTM"/>
		<result property="saleEndDtm"		column="SALE_END_DTM"/>
		<result property="showYn"			column="SHOW_YN"/>
		<result property="goodsTpCd"		column="GOODS_TP_CD"/>
		<result property="bigo"				column="BIGO"/>
		<result property="bndNo"			column="BND_NO"/>
		<result property="compNm"			column="COMP_NM"/>
		<result property="bndNmKo"			column="BND_NM_KO"/>
		<result property="saleAmt"			column="SALE_AMT"/>
		<result property="cpNo"				column="CP_NO"/>

		<collection property="stStdList" column="{goodsId=GOODS_ID}" javaType="java.util.ArrayList" ofType="biz.app.st.model.StStdInfoVO" select="inline.getStStdInfoGoodsById"/>
	</resultMap>

	<select id="listCouponGoods" resultMap="CouponTargetMap">
		<!--
			Query Name : coupon.listCouponGoods
			Description : 쿠폰과 연결된 사이트, 상품, 상품과 연결된 사이트 정보를 기준으로 조회한다.
		-->
		SELECT
		    A.GOODS_ID,
		    A.COMP_GOODS_ID,
		    A.GOODS_NM,
		    A.GOODS_STAT_CD,
		    A.MDL_NM,
		    A.COMP_NO,
		    A.MMFT,
		    A.SALE_STRT_DTM,
		    A.SALE_END_DTM,
		    A.SHOW_YN,
		    A.GOODS_TP_CD,
		    A.BIGO,
		    A.BND_NO,
		    B.COMP_NM,
			C.BND_NM_KO,
			D.SALE_AMT,
			F.CP_NO,
		    A.SYS_REG_DTM
		FROM GOODS_BASE A
	        JOIN COUPON_TARGET F ON A.GOODS_ID = F.GOODS_ID
	        JOIN COUPON_BASE K ON F.CP_NO = K.CP_NO
	        JOIN COMPANY_BASE B ON A.COMP_NO = B.COMP_NO
	        JOIN GOODS_PRICE D ON (A.GOODS_ID = D.GOODS_ID AND NOW() BETWEEN D.SALE_STRT_DTM AND D.SALE_END_DTM)
	        LEFT JOIN BRAND_BASE C ON A.BND_NO = C.BND_NO
		WHERE
		    K.CP_NO = #{cpNo}
		    <if test="stStdList != null and stStdList.size() != 0">
		    AND EXISTS (SELECT 1 FROM ST_GOODS_MAP SG WHERE SG.GOODS_ID = A.GOODS_ID
		    	<foreach collection="stStdList" item="st" separator="," open="AND SG.ST_ID IN (" close=")">
		    	#{st.stId}
		    	</foreach>
		    )
		    AND EXISTS (SELECT 1 FROM ST_PRMT_MAP SP WHERE SP.APL_NO = F.CP_NO
		    	<foreach collection="stStdList" item="st" separator="," open="AND SP.ST_ID IN (" close=")">
		    	#{st.stId}
		    	</foreach>
		    	AND SP.PRMT_APL_GB_CD = '${@framework.common.constants.CommonConstants@PRMT_APL_GB_20}')
		    </if>
		    AND D.DEL_YN = '${@framework.common.constants.CommonConstants@COMM_YN_N}'
		<include refid="bizCommon.sortSql" />
	</select>

	<select id="listCouponGoodsEx" resultMap="CouponTargetMap">
		<!--
			Query Name : coupon.listCouponGoodsEx
			Description : 쿠폰과 연결된 사이트, 상품, 상품과 연결된 사이트 정보를 기준으로 쿠폰 제외 상품을 조회한다.
		-->
		SELECT
		    A.GOODS_ID,
		    A.GOODS_NM,
		    A.GOODS_STAT_CD,
		    A.MDL_NM,
		    A.COMP_NO,
		    A.MMFT,
		    A.SALE_STRT_DTM,
		    A.SALE_END_DTM,
		    A.SHOW_YN,
		    A.GOODS_TP_CD,
		    A.BIGO,
		    A.BND_NO,
		    B.COMP_NM,
			C.BND_NM_KO,
			D.SALE_AMT,
			F.CP_NO
		FROM GOODS_BASE A
	        JOIN COUPON_EXCEPT_GOODS F ON A.GOODS_ID = F.GOODS_ID
	        JOIN COUPON_BASE K ON F.CP_NO = K.CP_NO
	        JOIN COMPANY_BASE B ON A.COMP_NO = B.COMP_NO
	        JOIN GOODS_PRICE D ON (A.GOODS_ID = D.GOODS_ID AND NOW() BETWEEN D.SALE_STRT_DTM AND D.SALE_END_DTM)
	        LEFT JOIN BRAND_BASE C ON A.BND_NO = C.BND_NO
		WHERE
		    K.CP_NO = #{cpNo}
		    <if test="stStdList != null and stStdList.size() != 0">
		    AND EXISTS (SELECT 1 FROM ST_GOODS_MAP SG WHERE SG.GOODS_ID = A.GOODS_ID
		    	<foreach collection="stStdList" item="st" separator="," open="AND SG.ST_ID IN (" close=")">
		    	#{st.stId}
		    	</foreach>
		    )
		    AND EXISTS (SELECT 1 FROM ST_PRMT_MAP SP WHERE SP.APL_NO = F.CP_NO
		    	<foreach collection="stStdList" item="st" separator="," open="AND SP.ST_ID IN (" close=")">
		    	#{st.stId}
		    	</foreach>
		    	AND SP.PRMT_APL_GB_CD = '${@framework.common.constants.CommonConstants@PRMT_APL_GB_20}')
		    </if>
		    AND D.DEL_YN = '${@framework.common.constants.CommonConstants@COMM_YN_N}'
	</select>

	<resultMap type="biz.app.promotion.model.DisplayCouponTreeVO" id="resultDisplayTree">
		<id     property="id"			column="ID"/>
		<result property="text"			column="TEXT"/>
		<result property="parent"		column="PARENT"/>
		<result property="leaf"		column="LEAF"/>
		<collection property="state" ofType="biz.app.promotion.model.DisplayCouponTreeStateVO">
			<result property="selected"	column="SELECTED"/>
		</collection>
	</resultMap>

	<select id="listCouponDisplayTree" resultMap="resultDisplayTree">
		<!--
			Query Name : coupon.listCouponDisplayTree
			Description : test
		-->
		SELECT	/* QUERYID(coupon.listCouponDisplayTree) */
				A.DISP_CLSF_NO		AS ID		/* 전시 분류 번호 */
				, A.DISP_CLSF_NM		AS TEXT		/* 전시 분류 명 */
				, A.UP_DISP_CLSF_NO	AS PARENT	/* 상위 전시 분류 번호 */
				, IF(B.CP_NO IS NOT NULL, 'true', 'false') AS SELECTED
		FROM	DISPLAY_CATEGORY A
		LEFT OUTER JOIN COUPON_TARGET B ON A.DISP_CLSF_NO = B.DISP_CLSF_NO AND B.CP_NO = ${cpNo}
		WHERE	A.DEL_YN = '${@framework.common.constants.CommonConstants@DEL_YN_N}'
		    AND A.ST_ID = #{stId}  
		<choose>
			<when test="dispClsfCd != null and dispClsfCd != ''">
			AND		A.DISP_CLSF_CD = #{dispClsfCd}
			</when>
			<otherwise>
			AND		A.DISP_CLSF_CD = '${@framework.common.constants.CommonConstants@DISP_CLSF_10}'
			</otherwise>
		</choose>
		ORDER BY DISP_LVL, DISP_PRIOR_RANK
	</select>
	
	<select id="listCouponShowDispClsf" resultType="biz.app.promotion.model.DisplayCouponTreeVO" >
		<!--
			Query Name : coupon.listCouponShowDispClsf
			Description : 쿠폰 전시분류 리스트     
		-->
		SELECT	/* QUERYID(coupon.listCouponShowDispClsf ) */
				  B.DISP_CLSF_NO			/* 전시 분류 번호 */
				, FN_GET_DISP_CTG_PATH(B.DISP_CLSF_NO ) DISP_CTG_PATH
				, B.CP_NO				/* 브랜드 번호 */
				, B.SYS_REGR_NO			/* 시스템 등록자 번호 */
				, B.SYS_REG_DTM			/* 시스템 등록 일시 */
				, FN_GET_USER_NAME(B.SYS_REGR_NO) AS SYS_REGR_NM	/* 시스템 등록자 */
				, FN_GET_USER_NAME(B.SYS_UPDR_NO) AS SYS_UPDR_NM	/* 시스템 수정자 */
				, D.ST_ID						/* 사이트 ID */
				, D.ST_NM					/* 사이트 명 */
		FROM	COUPON_TARGET B  
		INNER JOIN DISPLAY_CATEGORY     C ON (C.DISP_CLSF_NO = B.DISP_CLSF_NO)
		INNER JOIN ST_STD_INFO D ON (D.ST_ID = C.ST_ID)
		WHERE	1 = 1
		AND		B.CP_NO		= #{cpNo}
		ORDER BY   B.DISP_CLSF_NO
	</select>

	<insert id="insertCouponTarget" parameterType="biz.app.promotion.model.CouponTargetPO">
		<!--
			Query Name : coupon.insertCouponTarget
			Description : 쿠폰 적용 대상 상품 등록
		-->
		INSERT INTO COUPON_TARGET (
			  CP_NO				/* 쿠폰 번호 */
			, APL_SEQ			/* 적용 순번 */
			, DISP_CLSF_NO		/* 전시 분류 번호 */
			, EXHBT_NO			/* 기획전번호 */
			, GOODS_ID			/* 상품 아이디 */
			, COMP_NO           /* 업체번호 */
			, BND_NO            /* 브랜드번호 */
			, SYS_REGR_NO		/* 시스템 등록자 번호 */
			, SYS_REG_DTM		/* 시스템 등록 일시 */
			, SYS_UPDR_NO		/* 시스템 수정자 번호 */
			, SYS_UPD_DTM		/* 시스템 수정 일시 */
		) SELECT
			  #{cpNo}			/* 쿠폰 번호 */
			, (SELECT IFNULL(MAX(APL_SEQ), 0) + 1 FROM COUPON_TARGET WHERE CP_NO = #{cpNo})			/* 적용 순번 */
			, #{dispClsfNo}		/* 전시 분류 번호 */
			, #{exhbtNo}		/* 기획전번호 */
			, #{goodsId}		/* 상품 아이디 */
			, #{compNo}         /* 업체번호 */
			, #{bndNo}          /* 브랜드번호 */
			, #{sysRegrNo}		/* 시스템 등록자 번호 */
			, NOW()				/* 시스템 등록 일시 */
			, #{sysUpdrNo}		/* 시스템 수정자 번호 */
			, NOW()				/* 시스템 수정 일시 */

	</insert>

	<delete id="deleteCouponTarget" parameterType="biz.app.promotion.model.CouponBasePO">
		<!--
			Query Name : coupon.deleteCouponTarget
			Description : 쿠폰 적용 대상 상품 삭제
		-->
		DELETE
		FROM	COUPON_TARGET
		WHERE	CP_NO = #{cpNo}
	</delete>

	<insert id="insertCouponExTarget" parameterType="biz.app.promotion.model.CouponTargetPO">
		<!--
			Query Name : coupon.insertCouponExTarget
			Description : 쿠폰 적용 제외 상품 등록
		-->
		INSERT INTO COUPON_EXCEPT_GOODS (
			  CP_NO				/* 쿠폰 번호 */
			, GOODS_ID			/* 상품 아이디 */
			, SYS_REGR_NO		/* 시스템 등록자 번호 */
			, SYS_REG_DTM		/* 시스템 등록 일시 */
			, SYS_UPDR_NO		/* 시스템 수정자 번호 */
			, SYS_UPD_DTM		/* 시스템 수정 일시 */
		) VALUES (
			  #{cpNo}			/* 쿠폰 번호 */
			, #{goodsId}		/* 상품 아이디 */
			, #{sysRegrNo}		/* 시스템 등록자 번호 */
			, NOW()				/* 시스템 등록 일시 */
			, #{sysUpdrNo}		/* 시스템 수정자 번호 */
			, NOW()				/* 시스템 수정 일시 */
		)
	</insert>

	<delete id="deleteCouponExTarget" parameterType="biz.app.promotion.model.CouponBasePO">
		<!--
			Query Name : coupon.deleteCouponExTarget
			Description : 쿠폰 적용 제외 대상 상품 삭제
		-->
		DELETE
		FROM	COUPON_EXCEPT_GOODS
		WHERE	CP_NO = #{cpNo}
	</delete>

	<!-- 쿠폰 정보 -->
	<select id="getCoupon" resultType="biz.app.promotion.model.CouponBaseVO">
		<!--
			Query Name : coupon.getCoupon
			Description : 쿠폰 정보
		-->
		SELECT	/* QUERYID(coupon.getCoupon) */
				  CB.CP_NO					/* 쿠폰 번호 */
					, CP_NM					/* 쿠폰 명 */
					, CP_DSCRT				/* 쿠폰 설명 */
					, CP_KIND_CD			/* 쿠폰 종류 코드 */
					, CP_STAT_CD			/* 쿠폰 상태 코드 */
					, CP_APL_CD				/* 쿠폰 적용 코드 */
					, CP_TG_CD				/* 쿠폰 대상 코드 */
					, VLD_PRD_CD			/* 유효 기간 코드 */
					, VLD_PRD_STRT_DTM		/* 유효 기간 시작 일시 */
					, VLD_PRD_END_DTM		/* 유효 기간 종료 일시 */
					, VLD_PRD_DAY			/* 유효 기간 일 */
					, CP_PVD_MTH_CD			/* 쿠폰 지급 방식 코드 */
					, DUPLE_USE_YN			/* 중복 사용 여부 */
					, CP_RSTR_YN            /* 복원 가능 여부 */
					, SPL_COMP_DVD_RATE		/* 공급 업체 분담 율 */
					, ISU_HOST_CD			/* 발급 주체 코드 */
					, CP_ISU_CD				/* 쿠폰 발급 코드 */
					, CP_ISU_QTY			/* 쿠폰 발급 수량 */
					, WEB_MOBILE_GB_CD		/* 웹 모바일 구분 코드 */
					, APL_VAL				/* 적용 값 */
					, MIN_BUY_AMT			/* 최소 구매 금액 */
					, MAX_DC_AMT			/* 최대 할인 금액 */
					, RVS_MRG_PMT_YN		/* 역 마진 허용 여부 */
					, APL_STRT_DTM			/* 적용 시작 일시 */
					, APL_END_DTM			/* 적용 종료 일시 */
					, CP_IMG_FLNM			/* 쿠폰 이미지 파일명 */
					, CP_IMG_PATHNM			/* 쿠폰 이미지 경로명 */
					, CP_SHOW_YN            /* 쿠폰존 노출 여부 */
					, ISU_TG_CD				/* 발급 대상 코드 */
					, MSG_SND_YN			/* 메세지 발송 여부 */
					, EXPR_ITDC_YN			/* 만료 안내 여부 */
					, OUTSIDE_CP_YN			/* 외부 쿠폰 여부 */
					, OUTSIDE_CP_CD			/* 외부 쿠폰 코드 */
					, NOTICE				/* 유의사항 */
					, MULTI_APL_YN			/* 복수 적용 여부 */
					, GROUP_CONCAT(CMG.MBR_GRD_CD) AS MBR_GRD_CD /* 회원 등급 코드 */
					, CB.SYS_REGR_NO		/* 시스템 등록자 번호 */
					, CB.SYS_REG_DTM		/* 시스템 등록 일시 */
					, SYS_UPDR_NO			/* 시스템 수정자 번호 */
					, SYS_UPD_DTM			/* 시스템 수정 일시 */
					, FN_GET_USER_NAME(CB.SYS_REGR_NO) AS SYS_REGR_NM	/* 시스템 등록자 */
					, FN_GET_USER_NAME(SYS_UPDR_NO) AS SYS_UPDR_NM	/* 시스템 수정자 */
				<choose>
					<when test='mbrNo != null and mbrNo != ""'>
				, IF((SELECT	IFNULL(COUNT(CP_NO), 0) AS MEMBER_CNT	FROM	MEMBER_COUPON AS MC WHERE MC.CP_NO = CB.CP_NO AND MC.MBR_NO = #{mbrNo} ) > 0, '${@framework.common.constants.CommonConstants@COMM_YN_Y}','N') AS CP_DW_YN
				, IF((SELECT	IFNULL(COUNT(CP_NO), 0) AS MEMBER_CNT	FROM	MEMBER_COUPON WHERE CP_NO = CB.CP_NO AND USE_YN = 'N'  AND MBR_NO = #{mbrNo} ) > 0, 'N','Y') AS CP_USE_YN
					</when>
					<otherwise>
				, 'N' AS CP_DW_YN
					</otherwise>
				</choose>
		FROM	COUPON_BASE CB
		    LEFT OUTER JOIN COUPON_MBR_GRD CMG
		  	    ON CB.CP_NO = CMG.CP_NO
		WHERE	CB.CP_NO = #{cpNo}
	</select>

	<!-- 쿠폰 대상 상품 목록 -->
	<select id="pageCouponTargetGoods" resultType="biz.app.goods.model.GoodsBaseVO">
		SELECT	/* QUERYID(coupon.pageCouponTargetGoods) */
				DISTINCT GB.GOODS_NM
				, GB.GOODS_ID
				, GB.COMP_GOODS_ID
				, GB.PPLRT_RANK
				, GB.SALE_STRT_DTM
			    , GB.SALE_END_DTM
				, BD.BND_NM_KO
      			, (SELECT IMG_PATH FROM GOODS_IMG GI WHERE GI.GOODS_ID = GB.GOODS_ID AND GI.DLGT_YN = '${@framework.common.constants.CommonConstants@COMM_YN_Y}') AS IMG_PATH
      			, (SELECT COUNT(1) FROM GOODS_COMMENT COMMENT WHERE GOODS_ID = GB.GOODS_ID) AS COMMENT_CNT
      			, CAST(FN_SPLIT(FN_GET_GOODS_PRICE(GB.GOODS_ID, #{stId}, #{webMobileGbCd}), '|', 1) AS UNSIGNED) AS SALE_AMT
				, CAST(FN_SPLIT(FN_GET_GOODS_PRICE(GB.GOODS_ID, #{stId}, #{webMobileGbCd}), '|', 3) AS UNSIGNED) AS DC_AMT
				, GB.PR_WDS
				, GB.PR_WDS_SHOW_YN
				, GB.GOODS_STAT_CD
				, GI.IMG_PATH
				, GI.IMG_SEQ
				<if test='mbrNo != null'>
				, IF((SELECT COUNT(*) FROM MEMBER_INTEREST_GOODS MI WHERE GB.GOODS_ID = MI.GOODS_ID AND MI.MBR_NO = #{mbrNo}) > 0,  '${@framework.common.constants.CommonConstants@COMM_YN_Y}', '${@framework.common.constants.CommonConstants@COMM_YN_N}') AS INTEREST_YN
				</if>
		FROM	DISPLAY_GOODS DG
				INNER JOIN GOODS_BASE GB ON DG.GOODS_ID = GB.GOODS_ID
       			INNER JOIN COUPON_TARGET CT ON CT.GOODS_ID = GB.GOODS_ID
    			LEFT JOIN BRAND_BASE BD ON GB.BND_NO = BD.BND_NO
    			LEFT OUTER JOIN GOODS_IMG GI ON DG.GOODS_ID = GI.GOODS_ID
    	WHERE 1 = 1
    	<include refid="pageCouponTargetGoodsCondition" />
    	<include refid="bizCommon.sortSql" />
		<include refid="bizCommon.pageSql" />
	</select>

	<select id="pageCouponTargetGoodsCount" resultType="java.lang.Integer">
		<!--
			Query Name : coupon.pageCouponTargetGoodsCount
			Description : 쿠폰 대상 상품 목록 갯수
		-->
		SELECT	/* QUERYID(coupon.pageCouponTargetGoodsCount) */
				count(distinct
				IFNULL(GB.GOODS_ID, '')
				, IFNULL(GB.GOODS_NM, '')
				, IFNULL(GB.BND_NO, '')
				, IFNULL(GB.SALE_STRT_DTM, '')
				, IFNULL(GB.SALE_END_DTM, '')
				, IFNULL(GB.GOODS_STAT_CD, '')
				, IFNULL(GB.PPLRT_RANK, '')
				, IFNULL(BD.BND_NM_KO, '')
			)
		FROM	DISPLAY_GOODS DG
				INNER JOIN GOODS_BASE GB ON DG.GOODS_ID = GB.GOODS_ID
       			INNER JOIN COUPON_TARGET CT ON CT.GOODS_ID = GB.GOODS_ID
    			INNER JOIN BRAND_BASE BD ON GB.BND_NO = BD.BND_NO
    			LEFT OUTER JOIN GOODS_IMG GI ON DG.GOODS_ID = GI.GOODS_ID
    	WHERE 1 = 1
		<include refid="pageCouponTargetGoodsCondition" />
	</select>

	<!-- 쿠폰  페이징 목록 조건절 -->
	<sql id="pageCouponTargetGoodsCondition">
		<if test="webMobileGbCds != null">
			<foreach collection="webMobileGbCds" item="code" separator="," open="AND GB.WEB_MOBILE_GB_CD IN (" close=")">
				#{code}
			</foreach>
		</if>
		AND GB.GOODS_STAT_CD = '40'
    	AND GB.SHOW_YN = '${@framework.common.constants.CommonConstants@COMM_YN_Y}'
    	AND NOW() BETWEEN GB.SALE_STRT_DTM AND GB.SALE_END_DTM
    	AND GI.DLGT_YN = '${@framework.common.constants.CommonConstants@COMM_YN_Y}'
    	AND CT.CP_NO = #{cpNo}
	</sql>


<select id="listCouponTargetCompNo" resultType="biz.app.company.model.CompanyBaseVO"> 
	SELECT  /* QUERYID(coupon.listCouponTargetCompNo) */
				  CT.CP_NO
                , CB.COMP_NO            /* 업체 번호 */
                , CB.COMP_NM            /* 업체 명 */
                , CB.UP_COMP_NO     /* 상위 업체 번호 */
                , (SELECT COMP_NM FROM COMPANY_BASE WHERE COMP_NO = NULL ) AS UP_COMP_NM     /* 상위 업체명 */
                , CB.BIZ_NO         /* 사업자 번호 */
                , CB.COMP_STAT_CD       /* 업체 상태 코드 */
                , CB.CEO_NM         /* 대표자 명 */
                , CB.BIZ_CDTS           /* 업태 */
                , CB.BIZ_TP         /* 종목 */
                , CB.COMP_GB_CD     /* 업체 구분 코드 */
                , CB.COMP_TP_CD     /* 업체 유형 코드 */
                , CB.FAX                /* 팩스 */
                , CB.TEL                /* 전화 */
                , CB.POST_NO_OLD        /* 우편 번호 구 */
                , CB.POST_NO_NEW        /* 우편 번호 신 */
                , CB.ROAD_ADDR          /* 도로 주소 */
                , CB.ROAD_DTL_ADDR      /* 도로 상세 주소 */
                , CB.PRCL_ADDR          /* 지번 주소 */
                , CB.PRCL_DTL_ADDR      /* 지번 상세 주소 */
                , CB.BIGO               /* 비고 */
				, CB.SYS_REGR_NO        /* 시스템 등록자 번호 */
                , CB.SYS_REG_DTM        /* 시스템 등록 일시 */
                , CB.SYS_UPDR_NO        /* 시스템 수정자 번호 */
                , CB.SYS_UPD_DTM        /* 시스템 수정 일시 */
                , FN_GET_USER_NAME(CB.SYS_REGR_NO) AS SYS_REGR_NM   /* 시스템 등록자 */
                , FN_GET_USER_NAME(CB.SYS_UPDR_NO) AS SYS_UPDR_NM   /* 시스템 수정자 */
                , CASE WHEN UP_COMP_NO = 0 THEN 0 ELSE 1 END AS CP_LEVEL /* 레벨 */
		FROM    COMPANY_BASE CB 
		        INNER JOIN COUPON_TARGET CT ON CT.COMP_NO = CB.COMP_NO
        WHERE   1 = 1
          AND CT.CP_NO = #{cpNo}
    	<include refid="bizCommon.sortSql" />
</select>

<select id="listCouponTargetBndNo" resultType="biz.app.brand.model.BrandBaseVO"> 
	SELECT     /* QUERYID(coupon.listCouponTargetBndNo) */
			   CT.CP_NO
             , A.BND_NO
			 , A.BND_NM_KO
			 , A.BND_NM_EN
			 , A.USE_YN
			 , A.SORT_SEQ
			 , A.KO_INIT_CHAR_CD
			 , A.EN_INIT_CHAR_CD
			 , A.BND_ITRDC
			 , A.BND_ITRDC_IMG_PATH
			 , A.BND_SHOW_YN			 
			 , A.SYS_REGR_NO
			 , FN_GET_USER_NAME(A.SYS_REGR_NO) AS SYS_REGR_NM	/* 시스템 등록자 */
			 , A.SYS_REG_DTM
			, (
				CASE
					WHEN ASCII(SUBSTR(BND_NM_KO,1)) &gt; 128 THEN '1' -- 한글
					WHEN 64 &lt; ASCII(SUBSTR(BND_NM_KO,1)) &lt; 91 THEN '2' -- 대문자
					WHEN 96 &lt; ASCII(SUBSTR(BND_NM_KO,1)) &lt; 123 THEN '3' -- 소문자
					WHEN 47 &lt; ASCII(SUBSTR(BND_NM_KO,1)) &lt; 58 THEN '4' -- 숫자
					ELSE 5
				END
			) AS COL_ORD
		  FROM BRAND_BASE A
		       INNER JOIN COUPON_TARGET CT ON CT.BND_NO = A.BND_NO
		 WHERE 1 = 1
         AND CT.CP_NO = #{cpNo}
	<include refid="bizCommon.sortSql" />
</select>
 
	 

	<!-- 쿠폰 대상 카테고리 -->
	<select id="getCouponTargetCategory" resultType="biz.app.display.model.DisplayCategoryVO">
		SELECT /* QUERYID(coupon.getCouponTargetCategory) */
			DC.DISP_CLSF_NO,		/* 전시 분류 번호 */
			DC.DISP_CLSF_CD		/* 전시 분류 코드 */
 		FROM DISPLAY_CATEGORY DC INNER JOIN COUPON_TARGET CT ON DC.DISP_CLSF_NO = CT.DISP_CLSF_NO
 		WHERE     1 = 1
       		AND DC.DEL_YN = '${@framework.common.constants.CommonConstants@DEL_YN_N}'
       		AND DC.DISP_YN = '${@framework.common.constants.CommonConstants@DISP_YN_Y}'
       		AND CT.CP_NO = #{cpNo}
	</select>

	<resultMap type="biz.app.promotion.model.CouponIssueVO" id="CouponIssueMap">
		<result property="cpNo"					column="CP_NO"/>
		<result property="isuSrlNo"				column="ISU_SRL_NO"/>
		<result property="mbrCpNo"				column="MBR_CP_NO"/>
		<result property="useYn"				column="USE_YN"/>
		<result property="mbrNo"				column="MBR_NO"/>
		<result property="mbrNm"				column="MBR_NM"/>
		<result property="mbrNm" column="MBR_NM" typeHandler="biz.common.typehandler.CryptoTypeHandler" />
		<result property="useDtm"				column="USE_DTM"/>
		<result property="ordNo"				column="ORD_NO"/>
		<!-- result property="ordDtlSeq"			column="ORD_DTL_SEQ"/ -->
		<result property="cpNm"					column="CP_NM"/>
		<result property="cpKindCd"				column="CP_KIND_CD"/>
		<result property="prmtAplGbCd"			column="PRMT_APL_GB_CD"/>
		

		<collection property="stStdList" column="{aplNo=CP_NO, prmtAplGbCd=PRMT_APL_GB_CD}" javaType="java.util.ArrayList" ofType="biz.app.st.model.StStdInfoVO" select="inline.getStStdInfoPrmtById"/>
	</resultMap>

	<select id="pageCouponIssue" resultMap="CouponIssueMap">
		<!--
			Query Name : Coupon.pageCouponIssue
			Description : 쿠폰 수동 회원 조회
		-->
		SELECT	/* QUERYID(coupon.pageCouponIssue)  */
				  CI.CP_NO			/* 쿠폰 번호 */
				, CI.ISU_SRL_NO		/* 발급 일련 번호 */
				, MB.MBR_CP_NO		/* 회원 쿠폰 번호 */
				, MB.USE_YN			/* 사용 여부 */
				, MB.MBR_NO			/* 회원 번호 */
				, FN_GET_MEMBER_NAME(MB.MBR_NO) AS MBR_NM	/* 시스템 등록자 */
				, MB.USE_DTM		/* 사용 일시 */
				, MB.ORD_NO			/* 주문 번호 */
				, '${@framework.common.constants.CommonConstants@PRMT_APL_GB_20}' AS PRMT_APL_GB_CD
		FROM	COUPON_ISSUE CI
		LEFT JOIN MEMBER_COUPON MB
		    <choose>
				<when test="cpPvdMthCd.equals(@framework.common.constants.CommonConstants@CP_PVD_MTH_20) and cpIsuQty == 1L">
					ON CI.CP_NO = MB.CP_NO
				</when>
		    	<otherwise>
					ON CI.MBR_CP_NO = MB.MBR_CP_NO
				</otherwise>
			</choose>
		WHERE	CI.CP_NO = #{cpNo}
		<if test="stStdList != null and stStdList.size() != 0">
			AND EXISTS (SELECT 1 FROM ST_PRMT_MAP SP WHERE SP.APL_NO = CI.CP_NO
			<foreach collection="stStdList" item="st" separator="," open="AND SP.ST_ID IN (" close=")">
		    	#{st.stId}
		   	</foreach>
		   		AND SP.PRMT_APL_GB_CD = '${@framework.common.constants.CommonConstants@PRMT_APL_GB_20}')
		</if>
		<include refid="bizCommon.sortSql" />
		<include refid="bizCommon.pageSql" />
	</select>

	<select id="pageCouponIssueCount" resultType="java.lang.Integer">
		SELECT
			COUNT(*)
		FROM(
			SELECT	/* QUERYID(coupon.pageCouponIssueCount) */
					MB.CP_NO
			FROM	COUPON_ISSUE CI LEFT JOIN MEMBER_COUPON MB ON CI.MBR_CP_NO = MB.MBR_CP_NO
			WHERE	CI.CP_NO = #{cpNo}
			<if test="stStdList != null and stStdList.size() != 0">
				AND EXISTS (SELECT 1 FROM ST_PRMT_MAP SP WHERE SP.APL_NO = CI.CP_NO
				<foreach collection="stStdList" item="st" separator="," open="AND SP.ST_ID IN (" close=")">
			    	#{st.stId}
			   	</foreach>
			   		AND SP.PRMT_APL_GB_CD = '${@framework.common.constants.CommonConstants@PRMT_APL_GB_20}')
			</if>
			UNION ALL
			SELECT
				MBS.CP_NO
			FROM COUPON_ISU_STB MBS
			WHERE MBS.CP_NO = #{cpNo}
			AND MBS.USE_YN = 'N') a
	</select>

	<select id="pageDownCouponIssue" resultMap="CouponIssueMap">
		<!--
			Query Name : Coupon.pageDownCouponIssue
			Description : 다운로드/자동쿠폰 회원목록 조회
		-->
		SELECT	/* QUERYID(coupon.pageDownCouponIssue)  */
				  MB.MBR_CP_NO		/* 회원 쿠폰 번호 */
				, MB.CP_NO			/* 쿠폰 번호 */
				, MB.USE_YN			/* 사용 여부 */
				, MB.MBR_NO			/* 회원 번호 */
				, FN_GET_MEMBER_NAME(MB.MBR_NO) AS MBR_NM	/* 시스템 등록자 */
				, MB.USE_DTM		/* 사용 일시 */
				, MB.ORD_NO			/* 주문 번호 */
		     	, MB.SYS_REG_DTM	/* 시스템 등록 일시(=발급 일시) */
				, C.CP_NM			/* 쿠폰 이름 */
				, C.CP_KIND_CD		/* 쿠폰 유형 */
				, '${@framework.common.constants.CommonConstants@PRMT_APL_GB_20}' AS PRMT_APL_GB_CD
				, '2' AS COUPON_ISSU_GBN
		FROM	MEMBER_COUPON MB JOIN COUPON_BASE C ON C.CP_NO = MB.CP_NO
		WHERE	MB.CP_NO = #{cpNo}
		<if test="stStdList != null and stStdList.size() != 0">
			AND EXISTS (SELECT 1 FROM ST_PRMT_MAP SP WHERE SP.APL_NO = MB.CP_NO
			<foreach collection="stStdList" item="st" separator="," open="AND SP.ST_ID IN (" close=")">
		    	#{st.stId}
		   	</foreach>
		   		AND SP.PRMT_APL_GB_CD = '${@framework.common.constants.CommonConstants@PRMT_APL_GB_20}')
		</if>
		<!-- <include refid="bizCommon.sortSql" /> -->
		UNION ALL
		SELECT
			NULL
			, MBS.CP_NO
			, NULL
			, MBS.MBR_NO
			, FN_GET_MEMBER_NAME(MBS.MBR_NO) AS MBR_NM
			, NULL
			, NULL
			, NULL
			, NULL
			, NULL
			, NULL
			, '1'
		FROM COUPON_ISU_STB MBS
		WHERE MBS.CP_NO = #{cpNo}
		AND MBS.USE_YN = 'N'
		ORDER BY COUPON_ISSU_GBN ASC, SYS_REG_DTM DESC, MBR_NO DESC
		<include refid="bizCommon.pageSql" />
	</select>

	<select id="pageDownCouponIssueCount" resultType="java.lang.Integer">
		SELECT	/* QUERYID(coupon.pageDownCouponIssueCount) */
				COUNT(*)
		FROM	 MEMBER_COUPON MB JOIN COUPON_BASE C ON C.CP_NO = MB.CP_NO
		WHERE	MB.CP_NO = #{cpNo}
		<if test="stStdList != null and stStdList.size() != 0">
			AND EXISTS (SELECT 1 FROM ST_PRMT_MAP SP WHERE SP.APL_NO = MB.CP_NO
			<foreach collection="stStdList" item="st" separator="," open="AND SP.ST_ID IN (" close=")">
		    	#{st.stId}
		   	</foreach>
		   		AND SP.PRMT_APL_GB_CD = '${@framework.common.constants.CommonConstants@PRMT_APL_GB_20}')
		</if>
	</select>

	<insert id="insertCouponIssue" parameterType="biz.app.promotion.model.CouponIssuePO">
		INSERT INTO COUPON_ISSUE (
			  CP_NO				/* 쿠폰 번호 */
			, ISU_SRL_NO		/* 발급 일련 번호 */
			, MBR_CP_NO			/* 회원 쿠폰 번호 */
			, SYS_REGR_NO		/* 시스템 등록자 번호 */
			, SYS_REG_DTM		/* 시스템 등록 일시 */
		) VALUES (
			  #{cpNo}			/* 쿠폰 번호 */
			, #{isuSrlNo}		/* 발급 일련 번호 */
			, #{mbrCpNo}		/* 회원 쿠폰 번호 */
			, #{sysRegrNo}		/* 시스템 등록자 번호 */
			, NOW()				/* 시스템 등록 일시 */
		)
	</insert>

	<delete id="deleteCouponIssue" parameterType="biz.app.promotion.model.CouponBasePO">
		DELETE
		FROM	COUPON_ISSUE
		WHERE	CP_NO = #{cpNo}
	</delete>

	<update id="updateBatchCouponCpStat">
		<!--
			Query Name : coupon.updateCouponBase
			Description : 쿠폰 베이스 수정
		-->
		UPDATE	COUPON_BASE SET
				CP_STAT_CD		= '${@framework.common.constants.CommonConstants@CP_STAT_40}'
				, SYS_UPDR_NO	= ${@framework.common.constants.CommonConstants@COMMON_BATCH_USR_NO}
				, SYS_UPD_DTM	= NOW()
		WHERE	CP_NO IN (
			SELECT	CP_NO
			FROM	(
				SELECT	CP_NO
				FROM	COUPON_BASE
				WHERE	APL_END_DTM <![CDATA[<]]> NOW()
				AND		CP_STAT_CD = '${@framework.common.constants.CommonConstants@CP_STAT_20}'
			) A
		)
	</update>

	<select id="goodsDlvrcPayMth" resultType="string">
		SELECT	/* QUERYID(coupon.goodsDlvrcPayMth) */
			IFNULL(t2.DLVRC_PAY_MTD_CD, '${@framework.common.constants.CommonConstants@DLVRC_PAY_MTD_10}') dlvrcPayMtdCd
		FROM goods_base t1, delivery_charge_policy t2
		WHERE t1.goods_id = #{goodsId} AND t1.dlvrc_plc_no = t2.dlvrc_plc_no
	</select>
	
	
	
	<select id="listCouponTargetExhbtNo" resultType="biz.app.promotion.model.ExhibitionVO">
		<!--
			Query Name : coupon.listCouponTargetExhbtNo
			Description : 기획전 페이지 리스트
		-->
		SELECT	/* QUERYID(exhibition.listCouponTargetExhbtNo) */
				  DISTINCT EXB.EXHBT_NO		/* 기획전 번호 */
				, EXB.EXHBT_NM				/* 기획전 명 */
				, EXB.EXHBT_GB_CD			/* 기획전 구분 코드 */
				, EXB.EXHBT_STAT_CD			/* 기획전 승인 상태 코드 */
				, EXB.DISP_YN		/* 전시 여부 */
				, EXB.DISP_STRT_DTM			/* 전시 시작 일시 */
				, EXB.DISP_END_DTM			/* 전시 종료 일시 */
				, STEXM.ST_ID
				, SI.ST_NM
				, EXB.SYS_REGR_NO			/* 시스템 등록자 번호 */
				, EXB.SYS_REG_DTM			/* 시스템 등록 일시 */
				, EXB.SYS_UPDR_NO			/* 시스템 수정자 번호 */
				, EXB.SYS_UPD_DTM			/* 시스템 수정 일시 */
				, FN_GET_USER_NAME(EXB.SYS_REGR_NO) AS SYS_REGR_NM	/* 시스템 등록자 */
				, FN_GET_USER_NAME(EXB.SYS_UPDR_NO) AS SYS_UPDR_NM	/* 시스템 수정자 */
				, EXB.BNR_IMG_PATH     /* 배너 이미지 경로 */
		     	, EXB.BNR_MO_IMG_PATH  /* 배너 모바일 이미지 경로 */
		FROM	EXHIBITION_BASE EXB
		INNER JOIN COUPON_TARGET CT  ON (CT.EXHBT_NO = EXB.EXHBT_NO ) 
		INNER JOIN ST_EXHIBITION_MAP STEXM ON STEXM.EXHBT_NO = EXB.EXHBT_NO
		LEFT OUTER JOIN EXHIBITION_THEME EXT ON EXT.EXHBT_NO = EXB.EXHBT_NO
		LEFT OUTER JOIN EXHIBITION_THEME_GOODS EXTG ON EXTG.THM_NO = EXT.THM_NO
		JOIN ST_STD_INFO SI ON SI.ST_ID = STEXM.ST_ID
		WHERE	1 = 1
		AND CT.CP_NO =  #{cpNo}
		AND EXB.DEL_YN = '${@framework.common.constants.CommonConstants@COMM_YN_N}'
		ORDER BY	EXB.EXHBT_NO  DESC
 
	</select>
	
	<select id="listCouponTarget" resultType="biz.app.promotion.model.CouponTargetVO">
		<!--
			Query Name : coupon.listCouponTarget
			Description : 쿠폰 대상 리스트
		-->
		SELECT	/* QUERYID(coupon.listCouponTarget) */
				CP_NO,
				APL_SEQ,
				EXHBT_NO,
				GOODS_ID,
				DISP_CLSF_NO,
				COMP_NO,
				BND_NO
		FROM	COUPON_TARGET CT
		WHERE	1 = 1
		  AND CT.CP_NO =  #{cpNo}
		ORDER BY	CT.APL_SEQ
	</select>
	
	<select id="listCouponExGoods" resultType="biz.app.promotion.model.CouponTargetVO">
		<!--
			Query Name : coupon.listCouponExGoods
			Description : 쿠폰 제외 상품 리스트
		-->
		SELECT	/* QUERYID(coupon.listCouponExGoods) */
				CP_NO,
				GOODS_ID
		FROM	COUPON_EXCEPT_GOODS CEG
		WHERE	1 = 1
		  AND CEG.CP_NO =  #{cpNo}
		ORDER BY	GOODS_ID
	</select>
	
	<insert id="insertCouponMbrGrd" parameterType="biz.app.promotion.model.CouponBasePO">
		<!--
			Query Name : coupon.insertCouponMbrGrd
			Description : 쿠폰 회원 등급 등록
		-->
		INSERT INTO COUPON_MBR_GRD (
			  CP_NO					/* 쿠폰 번호 */
			, MBR_GRD_CD			/* 회원 등급 코드 */
			, SYS_REGR_NO			/* 시스템 등록자 번호 */
			, SYS_REG_DTM			/* 시스템 등록 일시 */
		)
		VALUES (
			  #{cpNo}				/* 쿠폰 번호 */
			, #{mbrGrdCd}			/* 회원 등급 코드 */
			, #{sysRegrNo}			/* 시스템 등록자 번호 */
			, NOW()					/* 시스템 등록 일시 */
		)
	</insert>
	
	<delete id="deleteCouponMbrGrd" parameterType="biz.app.promotion.model.CouponBasePO">
		<!--
			Query Name : coupon.insertCouponMbrGrd
			Description : 쿠폰 회원 등급 삭제
		-->
		DELETE FROM COUPON_MBR_GRD
		 WHERE CP_NO = #{cpNo}
	</delete>
	
</mapper>